name: Keep Multiple Cookies Alive

on:
  schedule:
    # 每隔一定时间执行一次（默认每30分钟），可根据需要调整频率
    - cron: '*/30 * * * *'
  workflow_dispatch:

jobs:
  keep-session-active:
    runs-on: ubuntu-latest
    strategy:
      # 矩阵策略，为每个站点创建一个独立的任务
      matrix:
        site: 
          - { name: "site1" }
          - { name: "site2" }
          - { name: "site3" }
          - { name: "site4" }
          - { name: "site5" }
          - { name: "site6" }
          - { name: "site7" }
          - { name: "site8" }
          - { name: "site9" }
          - { name: "site10" }
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 'lts/*'
          
      - name: Create Multi-site Keep Alive Script
        run: |
          cat > keep-alive.js << 'EOF'
          const https = require('https');
          const fs = require('fs');
          const url = require('url');
          const { spawn } = require('child_process');
          
          // 从环境变量获取站点配置
          const siteConfig = {
            name: process.env.SITE_NAME,
            curlCommand: process.env.CUSTOM_CURL
          };
          
          // 检查是否提供了cURL命令
          if (!siteConfig.curlCommand) {
            console.error('No cURL command provided for this site');
            process.exit(0); // 正常退出而不是错误退出
          }
          
          // 构建cookie文件名
          const cookieFileName = `${siteConfig.name}-cookies.txt`;
          const responseFileName = `${siteConfig.name}-last-response.json`;
          
          // 解析cURL命令以提取URL和其他参数
          function parseCurlCommand(curlCmd) {
            // 简单解析cURL命令以提取URL和方法
            const urlMatch = curlCmd.match(/curl\s+'([^']+)'/) || curlCmd.match(/curl\s+"([^"]+)"/);
            const methodMatch = curlCmd.match(/-X\s+(\w+)/i);
            const headers = {};
            
            // 提取headers
            const headerMatches = curlCmd.matchAll(/-H\s+['"]([^:]+):\s*([^'"]*)['"]/gi);
            for (const match of headerMatches) {
              headers[match[1]] = match[2];
            }
            
            // 提取cookie
            let cookies = '';
            const cookieMatch = curlCmd.match(/-b\s+['"]([^'"]+)['"]/) || curlCmd.match(/--cookie\s+['"]([^'"]+)['"]/);
            if (cookieMatch) {
              cookies = cookieMatch[1];
            }
            
            // 提取POST数据
            let postData = '';
            const dataMatch = curlCmd.match(/--data-raw\s+['"]([^'"]+)['"]/) || curlCmd.match(/-d\s+['"]([^'"]+)['"]/);
            if (dataMatch) {
              postData = dataMatch[1];
            }
            
            return {
              url: urlMatch ? urlMatch[1] : '',
              method: methodMatch ? methodMatch[1].toUpperCase() : 'GET',
              headers: headers,
              cookies: cookies,
              postData: postData
            };
          }
          
          // 解析cURL命令
          const parsedCmd = parseCurlCommand(siteConfig.curlCommand);
          
          if (!parsedCmd.url) {
            console.error('Could not extract URL from cURL command');
            process.exit(1);
          }
          
          // 如果存在保存的cookie文件，则读取cookie
          if (fs.existsSync(cookieFileName)) {
            const cookies = fs.readFileSync(cookieFileName, 'utf8');
            parsedCmd.headers['Cookie'] = cookies;
            console.log(`Loaded cookies from ${cookieFileName}`);
          } else if (parsedCmd.cookies) {
            // 如果没有保存的cookie文件但提供了初始cookie，则使用初始cookie
            parsedCmd.headers['Cookie'] = parsedCmd.cookies;
            console.log('Using initial cookies provided via cURL command');
          }
          
          console.log(`Making ${parsedCmd.method} request to ${parsedCmd.url} at ${new Date().toISOString()}`);
          
          // 解析URL以获取主机名和路径
          let parsedUrl;
          try {
            parsedUrl = new URL(parsedCmd.url);
          } catch (e) {
            console.error(`Invalid URL: ${parsedCmd.url}`);
            process.exit(1);
          }
          
          const options = {
            hostname: parsedUrl.hostname,
            port: parsedUrl.port || (parsedUrl.protocol === 'https:' ? 443 : 80),
            path: parsedUrl.pathname + parsedUrl.search,
            method: parsedCmd.method,
            headers: parsedCmd.headers
          };
          
          // 发起HTTPS请求
          const req = https.request(options, (res) => {
            console.log(`${siteConfig.name}: STATUS: ${res.statusCode}`);
            
            // 保存Set-Cookie头到文件
            if (res.headers['set-cookie']) {
              const cookieString = res.headers['set-cookie'].join('; ');
              fs.writeFileSync(cookieFileName, cookieString);
              console.log(`${siteConfig.name}: Saved cookies to ${cookieFileName}`);
            }
            
            let data = '';
            res.on('data', (chunk) => {
              data += chunk;
            });
            
            res.on('end', () => {
              console.log(`${siteConfig.name}: Request completed successfully`);
              // 保存响应内容
              fs.writeFileSync(responseFileName, data);
            });
          });
          
          req.on('error', (e) => {
            console.error(`${siteConfig.name}: Problem with request: ${e.message}`);
          });
          
          // 如果有POST数据，则发送
          if (parsedCmd.postData) {
            req.write(parsedCmd.postData);
          }
          
          req.end();
          EOF
          
      - name: Execute Keep Alive Request for Site 1
        if: matrix.site.name == 'site1'
        env:
          SITE_NAME: site1
          CUSTOM_CURL: ${{ secrets.SITE1_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 2
        if: matrix.site.name == 'site2'
        env:
          SITE_NAME: site2
          CUSTOM_CURL: ${{ secrets.SITE2_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 3
        if: matrix.site.name == 'site3'
        env:
          SITE_NAME: site3
          CUSTOM_CURL: ${{ secrets.SITE3_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 4
        if: matrix.site.name == 'site4'
        env:
          SITE_NAME: site4
          CUSTOM_CURL: ${{ secrets.SITE4_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 5
        if: matrix.site.name == 'site5'
        env:
          SITE_NAME: site5
          CUSTOM_CURL: ${{ secrets.SITE5_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 6
        if: matrix.site.name == 'site6'
        env:
          SITE_NAME: site6
          CUSTOM_CURL: ${{ secrets.SITE6_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 7
        if: matrix.site.name == 'site7'
        env:
          SITE_NAME: site7
          CUSTOM_CURL: ${{ secrets.SITE7_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 8
        if: matrix.site.name == 'site8'
        env:
          SITE_NAME: site8
          CUSTOM_CURL: ${{ secrets.SITE8_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 9
        if: matrix.site.name == 'site9'
        env:
          SITE_NAME: site9
          CUSTOM_CURL: ${{ secrets.SITE9_CURL }}
        run: |
          node keep-alive.js
          
      - name: Execute Keep Alive Request for Site 10
        if: matrix.site.name == 'site10'
        env:
          SITE_NAME: site10
          CUSTOM_CURL: ${{ secrets.SITE10_CURL }}
        run: |
          node keep-alive.js
          
      - name: Save Cookies For Next Run (${{ matrix.site.name }})
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: ${{ matrix.site.name }}-session-cookies
          path: ${{ matrix.site.name }}-cookies.txt
          if-no-files-found: ignore
          
      - name: Save Response For Analysis (${{ matrix.site.name }})
        uses: actions/upload-artifact@v4
        if: success() || failure()
        with:
          name: ${{ matrix.site.name }}-last-response
          path: ${{ matrix.site.name }}-last-response.json
          if-no-files-found: ignore